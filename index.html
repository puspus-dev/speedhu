<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SpeedHU - Sebességmérés</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #e5e7eb; /* világos szürke */
    color: #111;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    min-height:100vh;
    padding:1rem;
  }
  .circle-container {
    position: relative;
    width: 280px;
    height: 280px;
    margin-bottom: 1rem;
    cursor: pointer;
  }
  .circle-bg, .circle-fill {
    position: absolute;
    top:0; left:0;
    width:100%; height:100%;
    border-radius:50%;
  }
  .circle-bg {
    background:#d1d5db; /* világosabb háttér a kör mögött */
  }
  .circle-fill {
    background: conic-gradient(#fff 0deg, #fff 0deg);
    transform: rotate(-135deg);
    transition: background 0.2s linear;
  }
  .circle-inner {
    position:absolute;
    top:50%; left:50%;
    transform:translate(-50%,-50%);
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
  }
  .circle-value {
    font-size:48px;
    font-weight:bold;
  }
  .circle-label {
    font-size:16px;
    color:#4b5563;
  }
  .info {
    display:flex;
    gap:2rem;
    margin-top:1rem;
    text-align:center;
  }
  .info div { flex:1; }
</style>
</head>
<body>

<div class="circle-container" id="circle">
  <div class="circle-bg"></div>
  <div class="circle-fill" id="circleFill"></div>
  <div class="circle-inner" id="circleInner">
    <div class="circle-value" id="speedText">Teszt!</div>
    <div class="circle-label" id="circleLabel">Kattints a méréshez</div>
  </div>
</div>

<div class="info">
  <div>
    <div class="circle-value" id="ping">–</div>
    <div class="circle-label">Ping (ms)</div>
  </div>
  <div>
    <div class="circle-value" id="jitter">–</div>
    <div class="circle-label">Jitter (ms)</div>
  </div>
</div>

<script>
const circle = document.getElementById('circle');
const circleFill = document.getElementById('circleFill');
const speedText = document.getElementById('speedText');
const circleLabel = document.getElementById('circleLabel');
const pingEl = document.getElementById('ping');
const jitterEl = document.getElementById('jitter');

let running = false;
let phase = 'download';

function generateData(sizeMB) {
  const size = sizeMB*1024*1024;
  const buffer = new Uint8Array(size);
  crypto.getRandomValues(buffer);
  return new Blob([buffer]);
}

async function measurePing(samples=10) {
  const times=[];
  for(let i=0;i<samples;i++){
    const t0=performance.now();
    await new Promise(r=>setTimeout(r,50+Math.random()*50));
    const t1=performance.now();
    times.push(t1-t0);
  }
  const avg = times.reduce((a,b)=>a+b,0)/times.length;
  const variance = times.reduce((a,b)=>a+(b-avg)**2,0)/times.length;
  const jitter = Math.sqrt(variance);
  return {avg,jitter};
}

function updateCircle(mbps){
  const percent = Math.min(mbps/200*100,100);
  const color = phase==='download'?'#facc15':'#a78bfa';
  circleFill.style.background = `conic-gradient(${color} 0deg, ${color} ${percent*2.7}deg, #d1d5db ${percent*2.7}deg)`;
  speedText.textContent = mbps.toFixed(1);
}

async function measureSpeed(durationSec=5){
  const start = performance.now();
  let totalBytes = 0;
  let mbps = 0;
  while(performance.now()-start<durationSec*1000 && running){
    const blob = generateData(5);
    const buffer = await blob.arrayBuffer();
    totalBytes += buffer.byteLength;
    const elapsed = (performance.now()-start)/1000;
    const targetMbps = totalBytes*8/1e6/elapsed;
    mbps += (targetMbps - mbps) * 0.1;
    updateCircle(mbps);
    await new Promise(r=>setTimeout(r,50));
  }
  return mbps;
}

async function countdown() {
  for (let i = 3; i > 0; i--) {
    speedText.textContent = i;
    circleLabel.textContent = "Kezdés...";
    await new Promise(r => setTimeout(r, 1000));
  }
}

async function startTest(){
  if(running) return;
  running=true;
  await countdown();
  speedText.textContent='0.0';
  phase='download';

  const pingData = await measurePing();
  pingEl.textContent = pingData.avg.toFixed(1);
  jitterEl.textContent = pingData.jitter.toFixed(1);

  await measureSpeed(5);
  phase='upload';
  await measureSpeed(5);

  running=false;
  speedText.textContent='Kész!';
  circleLabel.textContent = "Újraindításhoz kattints";
}

circle.addEventListener('click', startTest);
</script>

</body>
</html>
