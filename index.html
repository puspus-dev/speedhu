<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SpeedHU – Sebességmérés</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #1b1b1b; color: white; }
    .gauge {
      width: 280px;
      height: 280px;
      border-radius: 50%;
      background: conic-gradient(#00b4d8 0deg, #2a2a2a 0deg);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      margin: auto;
    }
    .gauge-inner {
      background: #1b1b1b;
      width: 220px;
      height: 220px;
      border-radius: 50%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .gauge-value { font-size: 48px; font-weight: bold; }
    .label { font-size: 14px; color: #aaa; }
    .section { margin-bottom: 24px; text-align: center; }
  </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

  <h1 class="text-3xl font-bold mb-6">SpeedHU</h1>

  <div class="section">
    <div class="gauge" id="downloadGauge">
      <div class="gauge-inner">
        <div class="gauge-value" id="downloadSpeed">0.0</div>
        <div class="label">Mbps</div>
      </div>
    </div>
    <div class="label mt-2">Letöltés</div>
  </div>

  <div class="section">
    <div class="gauge" id="uploadGauge">
      <div class="gauge-inner">
        <div class="gauge-value" id="uploadSpeed">0.0</div>
        <div class="label">Mbps</div>
      </div>
    </div>
    <div class="label mt-2">Feltöltés</div>
  </div>

  <div class="section grid grid-cols-2 gap-6">
    <div>
      <div class="text-2xl font-bold" id="ping">–</div>
      <div class="label">Ping (ms)</div>
    </div>
    <div>
      <div class="text-2xl font-bold" id="jitter">–</div>
      <div class="label">Jitter (ms)</div>
    </div>
  </div>

  <button id="startBtn" class="bg-blue-500 px-6 py-3 rounded-full font-semibold hover:bg-blue-600 mt-6">
    Indítás
  </button>

  <script>
    const downloadGauge = document.getElementById('downloadGauge');
    const uploadGauge = document.getElementById('uploadGauge');
    const downloadSpeedEl = document.getElementById('downloadSpeed');
    const uploadSpeedEl = document.getElementById('uploadSpeed');
    const pingEl = document.getElementById('ping');
    const jitterEl = document.getElementById('jitter');
    const startBtn = document.getElementById('startBtn');

    let running = false;

    function updateGauge(el, percent) {
      const deg = (percent / 100) * 270;
      el.style.background = `conic-gradient(#00b4d8 ${deg}deg, #2a2a2a ${deg}deg)`;
    }

    function generateData(sizeMB) {
      const size = sizeMB * 1024 * 1024;
      const buffer = new Uint8Array(size);
      crypto.getRandomValues(buffer);
      return new Blob([buffer]);
    }

    async function measurePing(samples = 10) {
      const times = [];
      for (let i = 0; i < samples; i++) {
        const t0 = performance.now();
        await new Promise(r => setTimeout(r, 50 + Math.random()*50));
        const t1 = performance.now();
        times.push(t1 - t0);
      }
      const avg = times.reduce((a,b)=>a+b,0)/times.length;
      const variance = times.reduce((a,b)=>a+(b-avg)**2,0)/times.length;
      const jitter = Math.sqrt(variance);
      return { avg, jitter };
    }

    async function measureSpeed(el, displayEl, durationSec=5) {
      const start = performance.now();
      let totalBytes = 0;
      while (performance.now() - start < durationSec*1000 && running) {
        const blob = generateData(5); 
        const buffer = await blob.arrayBuffer();
        totalBytes += buffer.byteLength;
        const elapsed = (performance.now() - start)/1000;
        const mbps = totalBytes*8/1e6/elapsed;
        displayEl.textContent = mbps.toFixed(1);
        updateGauge(el, Math.min(mbps/200*100,100));
      }
    }

    startBtn.addEventListener('click', async ()=>{
      if(running) return;
      running=true;
      downloadSpeedEl.textContent = "0.0";
      uploadSpeedEl.textContent = "0.0";
      updateGauge(downloadGauge,0);
      updateGauge(uploadGauge,0);
      pingEl.textContent="…";
      jitterEl.textContent="…";

      const {avg, jitter} = await measurePing();
      pingEl.textContent = avg.toFixed(1);
      jitterEl.textContent = jitter.toFixed(1);

      await measureSpeed(downloadGauge, downloadSpeedEl, 5);
      await measureSpeed(uploadGauge, uploadSpeedEl, 5);

      running=false;
    });
  </script>
</body>
</html>
